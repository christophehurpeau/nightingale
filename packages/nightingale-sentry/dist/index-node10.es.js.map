{"version":3,"file":"index-node10.es.js","sources":["../src/index.ts"],"sourcesContent":["import { init, withScope, Severity } from '@sentry/node';\nimport { LogRecord, Handle } from 'nightingale-types';\nimport Level from 'nightingale-levels';\n\nconst mapToSentryLevel: Record<Level, string> = {\n  [Level.TRACE]: 'debug',\n  [Level.DEBUG]: 'debug',\n  [Level.INFO]: 'info',\n  [Level.NOTICE]: 'log',\n  [Level.WARNING]: 'warning',\n  [Level.ERROR]: 'error',\n  [Level.CRITICAL]: 'critical',\n  [Level.FATAL]: 'critical',\n  [Level.EMERGENCY]: 'critical',\n  // not a level\n  [Level.ALL]: 'fatal',\n};\n\nexport interface Options {\n  getUser?: <T>(record: LogRecord<T>) => any;\n  getTags?: <T>(record: LogRecord<T>) => any;\n}\n\nexport interface MetadataWithError {\n  error?: Error;\n}\n\nconst createHandler = (\n  dsn: string,\n  { getUser, getTags }: Options = {},\n): Handle => {\n  init({ dsn });\n\n  return <T extends MetadataWithError>(record: LogRecord<T>) => {\n    const { key, level, metadata, extra } = record;\n    const error = metadata?.error;\n\n    if (!error) {\n      return;\n    }\n\n    const extraData = { ...metadata, ...extra };\n    delete extraData.error;\n\n    withScope((scope) => {\n      scope.setLevel((mapToSentryLevel[level] || 'error') as Severity);\n      scope.setTag('loggerKey', key);\n\n      if (extraData) {\n        Object.keys(extraData).forEach((key) => {\n          scope.setExtra(key, extraData[key]);\n        });\n      }\n      if (getUser) {\n        const user = getUser(record);\n        if (user) scope.setUser(user);\n      }\n      if (getTags) {\n        const tags = getTags(record);\n        if (tags) {\n          Object.keys(tags).forEach((key) => {\n            scope.setTag(key, tags[key]);\n          });\n        }\n      }\n    });\n  };\n};\n\nexport default class SentryHandler {\n  minLevel: Level;\n\n  handle: Handle;\n\n  constructor(ravenUrl: string, minLevel: number, options?: Options) {\n    this.minLevel = minLevel;\n    this.handle = createHandler(ravenUrl, options);\n  }\n}\n"],"names":["mapToSentryLevel","Level","TRACE","DEBUG","INFO","NOTICE","WARNING","ERROR","CRITICAL","FATAL","EMERGENCY","ALL","createHandler","dsn","getUser","getTags","init","record","key","level","metadata","extra","error","extraData","withScope","scope","setLevel","setTag","Object","keys","forEach","setExtra","user","setUser","tags","SentryHandler","constructor","ravenUrl","minLevel","options","handle"],"mappings":";;;AAIA,MAAMA,gBAAuC,GAAG;AAC9C,GAACC,KAAK,CAACC,KAAP,GAAe,OAD+B;AAE9C,GAACD,KAAK,CAACE,KAAP,GAAe,OAF+B;AAG9C,GAACF,KAAK,CAACG,IAAP,GAAc,MAHgC;AAI9C,GAACH,KAAK,CAACI,MAAP,GAAgB,KAJ8B;AAK9C,GAACJ,KAAK,CAACK,OAAP,GAAiB,SAL6B;AAM9C,GAACL,KAAK,CAACM,KAAP,GAAe,OAN+B;AAO9C,GAACN,KAAK,CAACO,QAAP,GAAkB,UAP4B;AAQ9C,GAACP,KAAK,CAACQ,KAAP,GAAe,UAR+B;AAS9C,GAACR,KAAK,CAACS,SAAP,GAAmB,UAT2B;AAU9C;AACA,GAACT,KAAK,CAACU,GAAP,GAAa;AAXiC,CAAhD;;AAuBA,MAAMC,aAAa,GAAG,CACpBC,GADoB,EAEpB;AAAEC,EAAAA,OAAF;AAAWC,EAAAA;AAAX,IAAgC,EAFZ,KAGT;AACXC,EAAAA,IAAI,CAAC;AAAEH,IAAAA;AAAF,GAAD,CAAJ;AAEA,SAAqCI,MAA9B,IAAuD;AAC5D,UAAM;AAAEC,MAAAA,GAAF;AAAOC,MAAAA,KAAP;AAAcC,MAAAA,QAAd;AAAwBC,MAAAA;AAAxB,QAAkCJ,MAAxC;AACA,UAAMK,KAAK,GAAGF,QAAH,aAAGA,QAAH,uBAAGA,QAAQ,CAAEE,KAAxB;;AAEA,QAAI,CAACA,KAAL,EAAY;AACV;AACD;;AAED,UAAMC,SAAS,GAAG,EAAE,GAAGH,QAAL;AAAe,SAAGC;AAAlB,KAAlB;AACA,WAAOE,SAAS,CAACD,KAAjB;AAEAE,IAAAA,SAAS,CAAEC,KAAD,IAAW;AACnBA,MAAAA,KAAK,CAACC,QAAN,CAAgB1B,gBAAgB,CAACmB,KAAD,CAAhB,IAA2B,OAA3C;AACAM,MAAAA,KAAK,CAACE,MAAN,CAAa,WAAb,EAA0BT,GAA1B;;AAEA,UAAIK,SAAJ,EAAe;AACbK,QAAAA,MAAM,CAACC,IAAP,CAAYN,SAAZ,EAAuBO,OAAvB,CAAgCZ,GAAD,IAAS;AACtCO,UAAAA,KAAK,CAACM,QAAN,CAAeb,GAAf,EAAoBK,SAAS,CAACL,GAAD,CAA7B;AACD,SAFD;AAGD;;AACD,UAAIJ,OAAJ,EAAa;AACX,cAAMkB,IAAI,GAAGlB,OAAO,CAACG,MAAD,CAApB;AACA,YAAIe,IAAJ,EAAUP,KAAK,CAACQ,OAAN,CAAcD,IAAd;AACX;;AACD,UAAIjB,OAAJ,EAAa;AACX,cAAMmB,IAAI,GAAGnB,OAAO,CAACE,MAAD,CAApB;;AACA,YAAIiB,IAAJ,EAAU;AACRN,UAAAA,MAAM,CAACC,IAAP,CAAYK,IAAZ,EAAkBJ,OAAlB,CAA2BZ,GAAD,IAAS;AACjCO,YAAAA,KAAK,CAACE,MAAN,CAAaT,GAAb,EAAkBgB,IAAI,CAAChB,GAAD,CAAtB;AACD,WAFD;AAGD;AACF;AACF,KArBQ,CAAT;AAsBD,GAjCD;AAkCD,CAxCD;;AA0Ce,MAAMiB,aAAN,CAAoB;AAKjCC,EAAAA,WAAW,CAACC,QAAD,EAAmBC,QAAnB,EAAqCC,OAArC,EAAwD;AACjE,SAAKD,QAAL,GAAgBA,QAAhB;AACA,SAAKE,MAAL,GAAc5B,aAAa,CAACyB,QAAD,EAAWE,OAAX,CAA3B;AACD;;AARgC;;;;"}