{"version":3,"file":"index-node6.cjs.js","sources":["../src/config.ts","../src/index.ts"],"sourcesContent":["/* eslint-disable no-restricted-globals */\nimport { Handler, Processor } from 'nightingale-types';\nimport { ComputedConfigForKey } from 'nightingale-logger';\n\nexport interface Config {\n  handler?: Handler;\n  handlers?: Array<Handler>;\n  key?: string;\n  keys?: Array<string>;\n  pattern?: RegExp;\n  processor?: Processor;\n  processors?: Array<Processor>;\n  stop?: boolean;\n}\n\ndeclare const global: any;\n\nif (process.env.NODE_ENV !== 'production' && global.__NIGHTINGALE_GLOBAL_HANDLERS) {\n  // eslint-disable-next-line no-console\n  throw new Error('nightingale: update all to ^5.0.0');\n}\n\nif (!global.__NIGHTINGALE_CONFIG) {\n  global.__NIGHTINGALE_CONFIG = [];\n  global.__NIGHTINGALE_LOGGER_MAP_CACHE = new Map();\n  global.__NIGHTINGALE_CONFIG_DEFAULT = { handlers: [], processors: [] };\n}\n\nfunction clearCache() {\n  global.__NIGHTINGALE_LOGGER_MAP_CACHE.clear();\n}\n\nfunction handleConfig(config: Config) {\n  if (config.keys) {\n    if (config.pattern) {\n      throw new Error('Cannot have key and pattern for the same config');\n    }\n    if (config.key) {\n      throw new Error('Cannot have key and keys for the same config');\n    }\n  } else if (config.key) {\n    if (config.pattern) {\n      throw new Error('Cannot have key and pattern for the same config');\n    }\n    config.keys = [config.key];\n    delete config.key;\n  }\n\n  if (config.handler) {\n    if (config.handlers) {\n      throw new Error('Cannot have handler and handlers for the same config');\n    }\n    config.handlers = [config.handler];\n    delete config.handler;\n  }\n\n  if (config.processor) {\n    if (config.processors) {\n      throw new Error('Cannot have processors and processors for the same config');\n    }\n    config.processors = [config.processor];\n    delete config.processor;\n  }\n\n  return config;\n}\n\nexport function configure(config: Array<Config>) {\n  if (global.__NIGHTINGALE_CONFIG.length !== 0) {\n    // eslint-disable-next-line no-console\n    console.log('nightingale: warning: config overridden');\n  }\n\n  clearCache();\n  global.__NIGHTINGALE_CONFIG = config.map(handleConfig);\n}\n\nexport function addConfig(config: Config, unshift = false) {\n  config = handleConfig(config);\n  global.__NIGHTINGALE_CONFIG[unshift ? 'unshift' : 'push'](config);\n  clearCache();\n}\n\nconst configIsForKey = (key: string) => (config: Config) => {\n  if (config.keys) return config.keys.includes(key);\n  if (config.pattern) return config.pattern.test(key);\n  return true;\n};\n\nglobal.__NIGHTINGALE_GET_CONFIG_FOR_LOGGER = (key: string) => {\n  const globalCache = global.__NIGHTINGALE_LOGGER_MAP_CACHE;\n\n  if (globalCache.has(key)) {\n    return globalCache.get(key);\n  }\n\n  const loggerConfig: ComputedConfigForKey = {\n    handlers: [],\n    processors: [],\n  };\n\n  global.__NIGHTINGALE_CONFIG.filter(configIsForKey(key)).some((config: Config) => {\n    if (config.handlers) loggerConfig.handlers.push(...config.handlers);\n    if (config.processors) loggerConfig.processors.push(...config.processors);\n    return config.stop;\n  });\n\n  globalCache.set(key, loggerConfig);\n  return loggerConfig;\n};\n\nif (global.__NIGHTINGALE_GET_CONFIG_FOR_LOGGER_RECORD) {\n  global.__NIGHTINGALE_GET_CONFIG_FOR_LOGGER_RECORD = (\n    key: string,\n    level: number,\n  ): ComputedConfigForKey => {\n    const {\n      handlers,\n      processors,\n    }: ComputedConfigForKey = global.__NIGHTINGALE_GET_CONFIG_FOR_LOGGER(key);\n\n    return {\n      handlers: handlers.filter(\n        (handler: Handler) =>\n          level >= handler.minLevel && (!handler.isHandling || handler.isHandling(level, key)),\n      ),\n      processors,\n    };\n  };\n}\n","import Logger from 'nightingale-logger';\nimport Level from 'nightingale-levels';\n\nexport default Logger;\nexport { configure, addConfig } from './config';\nexport { Level, Level as levels };\n\n/**\n * listen to uncaughtException and unhandledRejection\n * @param {Logger} [logger]\n */\nexport function listenUnhandledErrors(\n  logger: Logger = new Logger('nightingale.listenUnhandledErrors', 'listenUnhandledErrors'),\n) {\n  process.on('uncaughtException', err => logger.error('uncaughtException', { err }));\n  process.on('unhandledRejection', err => logger.error('unhandledRejection', { err }));\n}\n"],"names":["process","env","NODE_ENV","global","__NIGHTINGALE_GLOBAL_HANDLERS","Error","__NIGHTINGALE_CONFIG","__NIGHTINGALE_LOGGER_MAP_CACHE","Map","__NIGHTINGALE_CONFIG_DEFAULT","clearCache","clear","handleConfig","config","keys","pattern","key","handler","handlers","processor","processors","configure","length","log","map","addConfig","unshift","configIsForKey","includes","test","__NIGHTINGALE_GET_CONFIG_FOR_LOGGER","globalCache","has","get","loggerConfig","filter","some","push","stop","set","__NIGHTINGALE_GET_CONFIG_FOR_LOGGER_RECORD","level","minLevel","isHandling","listenUnhandledErrors","logger","Logger","on","err","error"],"mappings":"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"}