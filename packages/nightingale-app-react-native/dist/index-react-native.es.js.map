{"version":3,"file":"index-react-native.es.js","sources":["../src/ReactNativeConsoleHandler.native.ts","../src/index.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unsafe-argument */\n\nimport { ANSIFormatter } from \"nightingale\";\nimport type {\n  Handle,\n  Handler,\n  IsHandling,\n  Level,\n  LogRecord,\n  Metadata,\n} from \"nightingale-types\";\nimport { Platform } from \"react-native\";\nimport type { StackFrame } from \"react-native/Libraries/Core/Devtools/parseErrorStack\";\nimport parseErrorStack from \"react-native/Libraries/Core/Devtools/parseErrorStack\";\nimport symbolicateStackTrace from \"react-native/Libraries/Core/Devtools/symbolicateStackTrace\";\n\nconst getStackTrace = (e: Error): any => {\n  // eslint-disable-next-line no-prototype-builtins\n  if (Platform.hasOwnProperty(\"constants\")) {\n    // RN version >= 0.63\n    if (Platform.constants.reactNativeVersion.minor >= 64) {\n      // RN version >= 0.64 -> Stacktrace as string\n      return parseErrorStack(e.stack);\n    }\n    // RN version == 0.63 -> Stacktrace as string\n    else return parseErrorStack(e as unknown as string);\n  }\n  // RN version < 0.63 -> Stacktrace as string\n  else return parseErrorStack(e as unknown as string);\n};\n\nfunction parsedStackToString(stack: StackFrame[]): string {\n  return stack\n    .map(\n      (frame) =>\n        `  at ${frame.file ?? \"unknown\"}${\n          frame.lineNumber\n            ? `:${frame.lineNumber}${frame.column ? `:${frame.column}` : \"\"}`\n            : \"\"\n        }${frame.methodName ? ` in ${frame.methodName}` : \"\"}`,\n    )\n    .join(\"\\n\");\n}\n\nfunction consoleOutput<T extends Metadata>(\n  param: string[],\n  record: LogRecord<T>,\n): void {\n  // eslint-disable-next-line no-console\n  console.log(...param);\n}\n\nconst createHandle = (): Handle => {\n  return <T extends Metadata>(record: LogRecord<T>): void => {\n    const metadataError = record.metadata?.error;\n    if (metadataError && metadataError instanceof Error) {\n      symbolicateStackTrace(getStackTrace(metadataError))\n        .then(({ stack, codeFrame }: any) => {\n          metadataError.stack = parsedStackToString(stack);\n          consoleOutput(ANSIFormatter.format(record), record);\n        })\n        .catch((error: unknown) => {\n          metadataError.stack = undefined;\n          consoleOutput(ANSIFormatter.format(record), record);\n        });\n    } else {\n      consoleOutput(ANSIFormatter.format(record), record);\n    }\n  };\n};\n\nexport class ReactNativeConsoleHandler implements Handler {\n  minLevel: Level = 0;\n\n  handle: Handle;\n\n  isHandling: IsHandling;\n\n  constructor(minLevel: Level) {\n    this.minLevel = minLevel;\n    this.isHandling = (level: Level) => level >= minLevel;\n    this.handle = createHandle();\n  }\n}\n","/* eslint-disable unicorn/prefer-global-this */\n\nimport { BrowserConsoleHandler, Level, Logger, configure } from \"nightingale\";\nimport { Platform } from \"react-native\";\nimport { ReactNativeConsoleHandler } from \"./ReactNativeConsoleHandler.native.ts\";\n\nexport { ReactNativeConsoleHandler } from \"./ReactNativeConsoleHandler.native.ts\";\n\nexport { configure, addConfig, Level } from \"nightingale\";\n\ninterface HermesInternalInterface {\n  hasPromise?: () => boolean;\n  enablePromiseRejectionTracker?: (options: any) => void;\n}\n\nexport const appLogger = new Logger(\"app\");\n\nexport const ReactNativeConsoleHandlerForPlatform:\n  | typeof BrowserConsoleHandler\n  | typeof ReactNativeConsoleHandler =\n  Platform.OS === \"web\" ? BrowserConsoleHandler : ReactNativeConsoleHandler;\n\nconfigure(\n  process.env.NODE_ENV === \"production\"\n    ? []\n    : [\n        {\n          pattern: /^app(:|$)/,\n          handlers: [new ReactNativeConsoleHandlerForPlatform(Level.DEBUG)],\n          stop: true,\n        },\n        {\n          handlers: [new ReactNativeConsoleHandlerForPlatform(Level.INFO)],\n        },\n      ],\n);\n\nexport function listenReactNativeUnhandledErrors(\n  logger: Logger = new Logger(\n    \"nightingale:listenReactNativeUnhandledErrors\",\n    \"UnhandledErrors\",\n  ),\n): void {\n  // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n  const HermesInternal = (global as any).HermesInternal as\n    | HermesInternalInterface\n    | null\n    | undefined;\n  // Check if Hermes is available and is being used for promises\n  // React Native v0.63 and v0.64 include global.HermesInternal but not 'hasPromise'\n  if (\n    HermesInternal?.hasPromise?.() &&\n    HermesInternal.enablePromiseRejectionTracker\n  ) {\n    HermesInternal.enablePromiseRejectionTracker({\n      allRejections: true,\n      onUnhandled: (id: number, rejection: Error) => {\n        logger.error(rejection, {\n          unhandled: true,\n          type: \"promiseRejectionTracker\",\n          id,\n        });\n      },\n    });\n  } else {\n    throw new Error(\"Only Hermes is supported.\");\n  }\n\n  const globalHandler = ErrorUtils.getGlobalHandler();\n\n  ErrorUtils.setGlobalHandler((error: Error, isFatal?: boolean) => {\n    if (isFatal) {\n      logger.fatal(error, { unhandled: true, type: \"globalHandler\", isFatal });\n    } else {\n      logger.error(error, { unhandled: true, type: \"globalHandler\", isFatal });\n    }\n\n    if (globalHandler) {\n      globalHandler(error, isFatal);\n    }\n  });\n}\n"],"names":[],"mappings":"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"}