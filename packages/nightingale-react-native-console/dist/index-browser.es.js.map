{"version":3,"file":"index-browser.es.js","sources":["../src/index.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unsafe-argument */\n\nimport { ANSIFormatter } from \"nightingale\";\nimport type {\n  Handle,\n  Handler,\n  IsHandling,\n  Level,\n  LogRecord,\n  Metadata,\n} from \"nightingale-types\";\nimport { Platform } from \"react-native\";\nimport type { StackFrame } from \"react-native/Libraries/Core/Devtools/parseErrorStack\";\nimport parseErrorStack from \"react-native/Libraries/Core/Devtools/parseErrorStack\";\nimport symbolicateStackTrace from \"react-native/Libraries/Core/Devtools/symbolicateStackTrace\";\n\nconst getStackTrace = (e: Error): any => {\n  // eslint-disable-next-line no-prototype-builtins\n  if (Platform.hasOwnProperty(\"constants\")) {\n    // RN version >= 0.63\n    if (Platform.constants.reactNativeVersion.minor >= 64) {\n      // RN version >= 0.64 -> Stacktrace as string\n      return parseErrorStack(e.stack as unknown as any);\n    }\n    // RN version == 0.63 -> Stacktrace as string\n    else return parseErrorStack(e);\n  }\n  // RN version < 0.63 -> Stacktrace as string\n  else return parseErrorStack(e);\n};\n\nfunction parsedStackToString(stack: StackFrame[]): string {\n  return stack\n    .map(\n      (frame) =>\n        `  at ${frame.file}${\n          frame.lineNumber\n            ? `:${frame.lineNumber}${frame.column ? `:${frame.column}` : \"\"}`\n            : \"\"\n        }${frame.methodName ? ` in ${frame.methodName}` : \"\"}`,\n    )\n    .join(\"\\n\");\n}\n\nfunction consoleOutput<T extends Metadata>(\n  param: string[],\n  record: LogRecord<T>,\n): void {\n  // eslint-disable-next-line no-console\n  console.log(...param);\n}\n\nconst createHandle = (): Handle => {\n  return <T extends Metadata>(record: LogRecord<T>): void => {\n    const metadataError = record.metadata?.error;\n    if (metadataError && metadataError instanceof Error) {\n      symbolicateStackTrace(getStackTrace(metadataError))\n        .then(({ stack, codeFrame }: any) => {\n          metadataError.stack = parsedStackToString(stack);\n          consoleOutput(ANSIFormatter.format(record), record);\n        })\n        .catch((error: unknown) => {\n          metadataError.stack = undefined;\n          consoleOutput(ANSIFormatter.format(record), record);\n        });\n    } else {\n      consoleOutput(ANSIFormatter.format(record), record);\n    }\n  };\n};\n\nexport class ReactNativeConsoleHandler implements Handler {\n  minLevel: Level = 0;\n\n  handle: Handle;\n\n  isHandling: IsHandling;\n\n  constructor(minLevel: Level) {\n    this.minLevel = minLevel;\n    this.isHandling = (level: Level) => level >= minLevel;\n    this.handle = createHandle();\n  }\n}\n"],"names":["getStackTrace","e","Platform","hasOwnProperty","constants","reactNativeVersion","minor","parseErrorStack","stack","parsedStackToString","map","frame","file","lineNumber","column","methodName","join","consoleOutput","param","console","log","createHandle","record","metadataError","metadata","error","Error","symbolicateStackTrace","then","codeFrame","ANSIFormatter","format","catch","undefined","ReactNativeConsoleHandler","minLevel","constructor","isHandling","level","handle"],"mappings":";;;;;AAAA;;AAgBA,MAAMA,aAAa,GAAIC,CAAQ,IAAU;AACvC;AACA,EAAA,IAAIC,QAAQ,CAACC,cAAc,CAAC,WAAW,CAAC,EAAE;AACxC;IACA,IAAID,QAAQ,CAACE,SAAS,CAACC,kBAAkB,CAACC,KAAK,IAAI,EAAE,EAAE;AACrD;AACA,MAAA,OAAOC,eAAe,CAACN,CAAC,CAACO,KAAuB,CAAC;AACnD;AACA;AAAA,SACK,OAAOD,eAAe,CAACN,CAAC,CAAC;AAChC;AACA;AAAA,OACK,OAAOM,eAAe,CAACN,CAAC,CAAC;AAChC,CAAC;AAED,SAASQ,mBAAmBA,CAACD,KAAmB,EAAU;EACxD,OAAOA,KAAK,CACTE,GAAG,CACDC,KAAK,IACJ,CAAQA,KAAAA,EAAAA,KAAK,CAACC,IAAI,CAChBD,EAAAA,KAAK,CAACE,UAAU,GACZ,CAAIF,CAAAA,EAAAA,KAAK,CAACE,UAAU,GAAGF,KAAK,CAACG,MAAM,GAAG,CAAIH,CAAAA,EAAAA,KAAK,CAACG,MAAM,CAAA,CAAE,GAAG,EAAE,CAAE,CAAA,GAC/D,EAAE,CACLH,EAAAA,KAAK,CAACI,UAAU,GAAG,CAAA,IAAA,EAAOJ,KAAK,CAACI,UAAU,CAAE,CAAA,GAAG,EAAE,CAAA,CACxD,CAAC,CACAC,IAAI,CAAC,IAAI,CAAC;AACf;AAEA,SAASC,aAAaA,CACpBC,KAAe,EAET;AACN;AACAC,EAAAA,OAAO,CAACC,GAAG,CAAC,GAAGF,KAAK,CAAC;AACvB;AAEA,MAAMG,YAAY,GAAGA,MAAc;AACjC,EAAA,OAA4BC,MAAoB,IAAW;AACzD,IAAA,MAAMC,aAAa,GAAGD,MAAM,CAACE,QAAQ,EAAEC,KAAK;AAC5C,IAAA,IAAIF,aAAa,IAAIA,aAAa,YAAYG,KAAK,EAAE;MACnDC,qBAAqB,CAAC3B,aAAa,CAACuB,aAAa,CAAC,CAAC,CAChDK,IAAI,CAAC,CAAC;QAAEpB,KAAK;AAAEqB,QAAAA;AAAe,OAAC,KAAK;AACnCN,QAAAA,aAAa,CAACf,KAAK,GAAGC,mBAAmB,CAACD,KAAK,CAAC;QAChDS,aAAa,CAACa,aAAa,CAACC,MAAM,CAACT,MAAM,CAAS,CAAC;AACrD,OAAC,CAAC,CACDU,KAAK,CAAC,MAAoB;QACzBT,aAAa,CAACf,KAAK,GAAGyB,SAAS;QAC/BhB,aAAa,CAACa,aAAa,CAACC,MAAM,CAACT,MAAM,CAAS,CAAC;AACrD,OAAC,CAAC;AACN,KAAC,MAAM;MACLL,aAAa,CAACa,aAAa,CAACC,MAAM,CAACT,MAAM,CAAS,CAAC;AACrD;GACD;AACH,CAAC;AAEM,MAAMY,yBAAyB,CAAoB;AACxDC,EAAAA,QAAQ,GAAU,CAAC;EAMnBC,WAAWA,CAACD,QAAe,EAAE;IAC3B,IAAI,CAACA,QAAQ,GAAGA,QAAQ;AACxB,IAAA,IAAI,CAACE,UAAU,GAAIC,KAAY,IAAKA,KAAK,IAAIH,QAAQ;AACrD,IAAA,IAAI,CAACI,MAAM,GAAGlB,YAAY,EAAE;AAC9B;AACF;;;;"}